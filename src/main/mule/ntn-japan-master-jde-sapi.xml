<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:salesforce-composite="http://www.mulesoft.org/schema/mule/salesforce-composite"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/salesforce-composite http://www.mulesoft.org/schema/mule/salesforce-composite/current/mule-salesforce-composite.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<flow name="ntn-japan-master-jde-sapiFlow-new" doc:id="578c10aa-2bf5-4b95-9baa-1d07c8c7d1f8" initialState="started">
		<scheduler doc:name="Scheduler" doc:id="044f123d-8c62-4422-9421-1c91f4bb05a5" >
			<scheduling-strategy >
				<fixed-frequency timeUnit="MINUTES" frequency="2"/>
			</scheduling-strategy>
		</scheduler>		
		<logger level="INFO" doc:name="start logger of ntn-japan-master-jde-sapi-flow" doc:id="54fc93c3-c802-48c5-9e74-cd66f6355504" message='#["start logger of ntn-japan-master-jde-sapi-flow"]'/>
		<ee:transform doc:name="Transform Message" doc:id="50f6df35-f90a-48e7-9a1c-abd895d00196" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="countQuery" ><![CDATA[p('db.countQuery')]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<db:select doc:name="Select" doc:id="ab2b5311-fb5e-44cb-8030-7a28c029573e" config-ref="db_config" target="count">
			<db:sql ><![CDATA[#[vars.countQuery]]]></db:sql>
		</db:select>
		<ee:transform doc:name="Transform Message" doc:id="12afbe70-ebaf-47ad-a972-3464dc3a19cc">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="query"><![CDATA[p('db.query')]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
		<db:select doc:name="Select" doc:id="872014a1-a651-486d-8d3e-7198b280e6ea" config-ref="db_config" fetchSize="#[vars.count[0].'COUNT(*)']" maxRows="#[vars.count[0].'COUNT(*)']">
			<db:sql><![CDATA[#[vars.query]]]></db:sql>
		</db:select>
		<logger level="INFO" doc:name="Logger" doc:id="7842c0de-0bc6-4a00-889e-a775f1de0ef1" message="#[sizeOf(payload)]" />
		<ee:transform doc:name="Transform Message" doc:id="fada2861-0b1f-4418-9f3e-b4a77afcc82b" >
			<ee:message >
				<ee:set-payload ><![CDATA[output application/json
---
payload]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="RCAA19" ><![CDATA[""]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<batch:job jobName="ntn-japan-master-jde-sapi-copyBatch_Job" doc:id="45d0a331-3f41-4368-b322-914f3ad26573" blockSize="1000">
			<batch:process-records >
				<batch:step name="Batch_Step" doc:id="6686045f-2adf-4835-a6ae-f70e7dde832a" >
					<ee:transform doc:name="Transform Message" doc:id="61c993e6-60df-48f1-adfe-ea289da4c542">
						<ee:message>
						</ee:message>
						<ee:variables>
							<ee:set-variable variableName="query"><![CDATA[%dw 2.0
output application/java
var cleanedPartNumber = (payload.RCAA19 default "") replace " " with ""
var externalId = trim(payload.RCAA19 default "") ++ "-JPN-NTN"
---
"SELECT Part_Number__c, Id, Name FROM Product2 WHERE  External_ID__c = '" ++ externalId ++ "'"
]]></ee:set-variable>
							<ee:set-variable variableName="cleanedPartNumber" ><![CDATA[%dw 2.0
output application/java
---
(payload.RCAA19 default "") replace " " with ""]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
					<ee:transform doc:name="Transform Message" doc:id="600c8c1d-ccd6-45ef-9f5e-8c7799eb2c0c">
								<ee:message>
							<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
  Part_Number__c : trim(payload.RCAA19),
  Stocking_Type_Code__c: 
    if (trim(payload."RC74USTA") == "0") "0-Customer pending apart no."
    else if (trim(payload."RC74USTA") == "1") "1-Available part no."
    else if (trim(payload."RC74USTA") == "2") "2-Old part no."
    else if (trim(payload."RC74USTA") == "3") "3-Part to be phased out"
    else if (trim(payload."RC74USTA") == "4") "4-Purchased part"
    else if (trim(payload."RC74USTA") == "6") "6-Production plan part no."
    else if (trim(payload."RC74USTA") == "7") "7-Dead part no."
    else if (trim(payload."RC74USTA") == "9") "9-Substitution part no."
    else "" ,
    External_ID__c : trim(payload.RCAA19) ++ "-JPN-NTN" ,
    NTN_Company_Number__c : "00001",
    Origin__c : "JPN",
    Brand__c : "NTN" ,
    Part_Number_Type__c : "Base" ,
    Source__c : "JAPAN",
    ProductCode : (trim(payload.RCAA19)),
    CIF_Min__c : 0.00,
    Landed_Cost_Max__c : 0.00 ,
    Landed_Cost_Min__c : 0.00 ,
    Estimated_Production_Lead_Time_Max__c : "0.00",
    Estimated_Production_Lead_Time_Min__c : "0.00",
    IsActive: true as Boolean ,
    Name: (trim(payload.RCAA19)),
    Update_Date__c : (payload.RCEVNTDATE as Date {format: "yyyyMMdd"}) as String {format: "yyyy-MM-dd"} as Date {format: "yyyy-MM-dd"}
}
]]></ee:set-payload>
								</ee:message>
								<ee:variables>
									<ee:set-variable variableName="RCAA19"><![CDATA[%dw 2.0
output application/json
---
trim(payload.RCAA19) default "" ++ "," ++ vars.RCAA19 as String]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
					<salesforce:query doc:name="Query" doc:id="a0689a64-277d-480b-b298-5cad47ab4164" config-ref="Salesforce_Config" target="sfresponse">
			<salesforce:salesforce-query><![CDATA[#[vars.query]]]></salesforce:salesforce-query>
		</salesforce:query>
					<choice doc:name="Choice" doc:id="bb3189ed-2016-4f47-b708-32f0a4ae3089" >
						<when expression="#[sizeOf(vars.sfresponse) &gt; 0]">
							<flow-ref doc:name="Flow Reference" doc:id="8c3dcf11-d284-45e3-8358-23ebb445248f" name="update_salesforce_Sub_Flow" />
						</when>
						<otherwise >
							<ee:transform doc:name="Transform Message" doc:id="369c1371-6126-48d2-9d8c-31b966fe9d08" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="queryPartNumber" ><![CDATA[%dw 2.0
output application/java
var externalId = trim(payload.RCAA19 default "") ++ "-JPN-NTN"
---
"SELECT Part_Number__c, Id, Name FROM Product2 WHERE  Part_Number__c = '" ++ vars.cleanedPartNumber ++ "'"
]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
							<salesforce:query doc:name="Query" doc:id="f24086cb-9314-4e90-900a-8df3fdd07695" config-ref="Salesforce_Config" target="partNumber">
								<salesforce:salesforce-query ><![CDATA[#[vars.queryPartNumber]]]></salesforce:salesforce-query>
							</salesforce:query>
							<choice doc:name="Choice" doc:id="6a8e4b12-356b-4dd2-beb6-58257597b4e4" >
								<when expression="#[sizeOf(vars.partNumber) &gt; 0]">
									<flow-ref doc:name="Flow Reference update subflow" doc:id="f126013e-bb2d-4f89-90b4-3d5110aea6fa" name="update_salesforce_Sub_Flow"/>
								</when>
								<otherwise >
									<flow-ref doc:name="Flow Reference create_salesforce_sub_Flow" doc:id="ec2d6be2-5577-483a-8b81-27f6121dc994" name="create_salesforce_sub_Flow"/>
								</otherwise>
							</choice>
						</otherwise>
					</choice>
					<ee:transform doc:name="Transform Message" doc:id="a8e419d9-7322-4e34-b9aa-6bee62467ae7" >
						<ee:message >
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload ++ {"Id": (vars.sfresponse."Id"[0])}]]></ee:set-payload>
						</ee:message>
					</ee:transform>
					<batch:aggregator doc:name="Batch Aggregator" doc:id="7d97a256-8961-487c-b72b-84af97e25912" size="5">
						<!-- [STUDIO:"Transform Message"]<ee:transform doc:name="Transform Message" doc:id="d797e419-94da-4c2c-8bb9-91da745db269">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
&#45;&#45;-
payload map read( $, 'application/json')&#93;&#93;></ee:set-payload>
							</ee:message>
						</ee:transform> [STUDIO] -->
						<!-- [STUDIO:"Transform Message1"]<ee:transform doc:name="Transform Message1" doc:id="039161e4-cd89-4c2d-b762-8df695cdd9a3">
							<ee:message />
							<ee:variables>
								<ee:set-variable variableName="createdata"><![CDATA[%dw 2.0
output application/json
&#45;&#45;-
payload  filter ((item, index) -> item.Id == null) 
&#93;&#93;></ee:set-variable>
								<ee:set-variable variableName="updatedata"><![CDATA[%dw 2.0
output application/json
&#45;&#45;-
payload 
    filter ((item, index) -> item.Id != null) 
&#93;&#93;></ee:set-variable>
							</ee:variables>
						</ee:transform> [STUDIO] -->
						<logger level="INFO" doc:name="Logger" doc:id="eefc942e-4011-4453-b922-d15c6b31c12c" message='#["aggregated product"]'/>
					</batch:aggregator>
				</batch:step>
			</batch:process-records>
			<batch:on-complete >
				<logger level="INFO" doc:name="Logger" doc:id="8cc4323b-74aa-47e3-9794-8f5dbd5a5bdb" message="#[payload]"/>
			</batch:on-complete>
		</batch:job>
		<logger level="INFO" doc:name="End Logger" doc:id="b07e6ca2-ce11-4e97-ac0c-067857a618a1" message='#[flatten(vars.errorIds ) filter ((item) -&gt; item != null)]'/>
		<error-handler ref="global-error-handler"/>
	</flow>
	<sub-flow name="update_salesforce_Sub_Flow" doc:id="63714603-db86-4144-87b3-1d2be3630903" >
									<logger level="INFO" doc:name="Logger" doc:id="c746ca17-3041-4734-927b-5fd63639174e" message='"salesforce update"' />
								<!-- [STUDIO:"Transform Message"]<ee:transform doc:name="Transform Message" doc:id="95a5e7e0-19b8-4536-991a-3f067d989567">
									<ee:message>
										<ee:set-payload><![CDATA[%dw 2.0
output application/json
&#45;&#45;-
payload filter ((item, index) -> item.Id != null) 
&#93;&#93;></ee:set-payload>
									</ee:message>
								</ee:transform> [STUDIO] -->
								<ee:transform doc:name="Transform Message" doc:id="d7704fc5-b7a1-4ad9-ba61-c7bf2407fcfb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
[payload ++ {"Id": (vars.sfresponse."Id"[0])} ]]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="20128153-0732-4153-a826-c71a4170c845" message="#[payload]"/>
		<salesforce:update doc:name="Update" doc:id="5ffcd99a-aa9b-4826-b2af-03c0bec350f7" config-ref="Salesforce_Config" type="Product2">
								</salesforce:update>
								<logger level="INFO" doc:name="Logger" doc:id="dbe7726c-d5eb-45d6-8daf-715005b73908" message="#[%dw 2.0&#10;output application/json&#10;---&#10;if (payload.successful == true) {Successful : payload.successful}&#10;else (payload.items map() -&gt; {&#10;	failedId: $.id,&#10;	message: $.message&#10;	&#10;})]" />
	</sub-flow>
	<sub-flow name="create_salesforce_sub_Flow" doc:id="48517557-b548-463b-be92-bf29e884599f" >
									<logger level="INFO" doc:name="Logger" doc:id="8db2aac6-1bec-45b5-8afa-ed7af4d9bcd3" message='"salesforce create"' />
								<ee:transform doc:name="Transform Message" doc:id="17ced4fd-e51f-4bb3-8874-b9c53cea238c">
									<ee:message>
										<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[payload]
]]></ee:set-payload>
									</ee:message>
									<ee:variables>
									</ee:variables>
								</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="7fb22d12-fa06-438e-9952-f63fa699266a" message="#[payload]"/>
		<salesforce:create doc:name="Create" doc:id="21f0b1c4-1b1d-41d1-a783-bbbe778d699d" config-ref="Salesforce_Config" type="Product2">
							</salesforce:create>
								<logger level="INFO" doc:name="Logger" doc:id="3015cb33-f7a5-41aa-b7e4-6fd2fbb013fb" message="#[%dw 2.0&#10;output application/json&#10;---&#10;if (payload.successful == true) {Successful : payload.successful}&#10;else (payload.items map() -&gt; {&#10;	failedId: $.id,&#10;	message: $.message&#10;	&#10;})]" />
								<ee:transform doc:name="Transform Message" doc:id="95eec4ca-7a3e-4bc4-8c92-e1e3b62f06c5">
									<ee:message>
									</ee:message>
									<ee:variables>
										<ee:set-variable resource="dwl/var-product2id.dwl" variableName="product2id" />
									</ee:variables>
								</ee:transform>
								<flow-ref doc:name="get-pricebook-id" doc:id="e876d101-3c22-49fa-afcf-d973ceab9ea9" name="get-pricebook-id" />
								<ee:transform doc:name="Transform Message" doc:id="b442acb5-068f-454d-86de-12529a9766fa">
									<ee:message>
										<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.createPB map (item, index) -> (
{
  	IsActive: item.IsActive,
  	CurrencyIsoCode : if(item.CurrencyIsoCode == "00001") "CAD" else "USD",
  	Product2Id : vars.product2id.Product2Id[index],
  	PriceBookId: payload,
  	UnitPrice : 0 
})]]></ee:set-payload>
									</ee:message>
								</ee:transform>
								<async doc:name="Async" doc:id="4b0034aa-c619-481a-8957-f166d73de81d">
									<http:request method="POST" doc:id="f0a7e35e-da0e-4ec6-bee6-2fdb3eb07e77" config-ref="HTTP_Request_configuration" path="${pricebooks.uri}" doc:name="Request" />
									<logger level="INFO" doc:name="Logger" doc:id="91653105-8dd0-4139-ac33-c8af8f5f1667" message='#["Request to PriceBooks API Completed."]' />
								</async>
	
	
	</sub-flow>
	<sub-flow name="get-pricebook-id" doc:id="3be9a04f-af55-4ae2-825f-67e72f5553ef" >
		<ee:transform doc:name="Transform Message" doc:id="22ad7221-bb69-4b4d-bbb8-ca2465db4b7e" >
			<ee:message >
				<ee:set-payload resource="dwl/priceBooks.dwl" />
			</ee:message>
		</ee:transform>
		<salesforce-composite:execute-composite-request doc:name="Execute composite request" doc:id="efdb93fa-a272-4a4f-a42e-b34321c12fd2" config-ref="Salesforce_Composite_Config" />
		<ee:transform doc:name="Transform Message" doc:id="4bf78030-17a2-4d3c-bac8-1fb3d2830d5d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{id:(payload.compositeResponse map ($..body."records")[0]) map ((item, index) -> item[0].Id)}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="bda8e6fb-b6f7-445b-bcd2-2de9f36d1261" message='"The list of PriceBook IDs are : " ++ #[payload]' />
	</sub-flow>
</mule>
